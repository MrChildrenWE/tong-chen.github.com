---
title: Docker usage
author: ct
layout: post
categories:
  - Docker
tags:
  - Docker
---

### Docker能做什么




### 安装和配置

* Centos 6.5 安装Docker

  ```bash

  #添加epel的源
  su -c 'rpm -Uvh  http://download.fedoraproject.org/pub/epel/6/i386/epel-release-6-8.noarch.rpm'
  yum update

  # 安装Docker
  yum install docker-io

  # 启动Docker服务
  service docker start

  # 设置Docker开机启动
  /sbin/chkconfig --add docker
  /sbin/chkconfig docker on
  ```

* 其他新版操作系统的安装可以直接使用系统自带的`yum`或`apt`工具，
  启动和配置如上。

  ```bash
  apt-get install docker.io
  ```


### Docker试用

* 查看本地Docker的信息 `docker info`
* 运行Docker需要有一个镜像和容器。镜像是容器的只读版本，
  最基础的镜像是一个操作系统，是运行其他命令的基础。
  因此我们需要先获取一个操作系统镜像，通常使用Ubuntu系统。
  我们也可以根据所要运行软件的需要，来获取不同的操作系统，
  方便软件的安装。
* 搜索镜像 `docker search ubuntu`; 镜像的名字通常由`用户名/镜像名`构成,
  无用户名的为官方认证镜像。	

  ```
  root@zinc:~# docker search ubuntu
  NAME              DESCRIPTION      STARS     OFFICIAL   AUTOMATED
  ubuntu            Ubuntu is ...    4595      [OK]       
  ubuntu-upstart    Upstart is...     66       [OK]
  jordi/ubuntu      Ubuntu bas...     1                    [OK] 
  ```

* 获取镜像 
  * `docker pull ubuntu` 获取镜像的最新版本
  * `docker pull ubuntu:14.04` 获取指定版本的镜像；14.04为镜像的版本号，
    正式名字为`TAG`。

* 查看本机Docker中存在的镜像 `docker images`
  
  ```
  REPOSITORY   TAG      IMAGE ID       CREATED      VIRTUAL SIZE
  ubuntu       latest   37b164bb431e   4 days ago   126.6 MB
  ```

* 获得了镜像之后，我们需要运行镜像；运行起来的镜像就是容器，是可读写的。
  我们可以在容器中安装软件、运行命令，就如在正常的操作系统中一样。
  
  交互式运行容器 `docker run -it ubuntu`, 这时可以发现终端的用户名变了
  
  ```bash
  root@zinc:~# docker run -it ubuntu
  root@57cb695e904f:/# ls
  bin   dev  home  lib64  mnt  proc  run   srv  tmp  var
  boot  etc  lib   media  opt  root  sbin  sys  usr
  root@57cb695e904f:/# 
  ```
  
  `docker run --help`可以查看这个命令的参数。

* 在容器中部署软件，安装`build-essential`和`r-base`; 
  *build-essential* 是编译软件包的基础，提供需要的编译器、头文件和库文件。
  *r-base* 是编译R语言程序包的基础。
  这一步我们可以安装任意的软件，测试时可以选择小一点的软件包。

  ```bash
  apt-get update
  apt-get install -y build-essential r-base
  ```

* 安装完成之后，我们希望把容器里的内容保存起来，
  以后就可以自己使用或者分发给他人使用。
  这就是把Docker容器转换为了镜像。

* 转换为镜像之前，我们需要先从容器中退出。

  ```bash
  root@57cb695e904f:/# exit
  exit
  root@zinc:~#
  ```
* `docker ps`可以查看当前都运行了哪些容器；
  `docker ps -a`可以查看都运行过哪些容器；

  ```bash
  root@zinc:~# docker ps -a
  CONTAINER ID   IMAGE    COMMAND       CREATED          STATUS                   PORTS   NAMES
  57cb695e904f   ubuntu   "/bin/bash"   21 hours ago     Up 21 hours                      hopeful_hopper      
  8aca49b869be   ubuntu   "/bin/bash"   22 hours ago     Exited (0) 21 hours ago          hungry_davinci      
  ef1b2f3b7200   ubuntu   "/bin/bash"   22 hours ago     Exited (0) 22 hours ago          grave_jones         
  d42fd33831f9   ubuntu   "echo Hello"   2 days ago      Exited (0) 2 days ago            lonely_bohr         
  6812822cbffe   ubuntu   "/bin/bash"    5 days ago      Up 5 days                        silly_newton   
  ```

* 使用`docker commit`命令把容器转换为镜像。

  ```bash
  docker commit -m 'Add build-essential r-base' -a username 8aca49b869be username/ubuntu-dev:v1
  ```
  `-m` 用来描述我们对容器做的修改；`-a`指定我们在docker hub上的用户名；
  `8aca49b869be`为容器的id；`username/ubuntu-dev:v1`目标镜像的用户名/仓库名和tag信息。
  仓库名可以理解为新生成的镜像的名字，下次再运行镜像时就可以使用这个新的名字了。

* 再次运行`docker images`可以看到我们刚刚创建的镜像。

  ```
  REPOSITORY           TAG      IMAGE ID       CREATED       VIRTUAL SIZE
  username/ubuntu-dev  v1       26d99f722dca   21 hours ago  658.2 MB
  ubuntu               latest   37b164bb431e   4 days ago    126.6 MB
  ```

* 运行新的镜像 `docker run -it username/ubuntu-dev:v1`。（测试用，此步可略过）

* 如果只是自己用，到现在就可以结束了，我们可以在镜像里面继续更多的操作了。
  如果我们想把镜像分发给别人使用，就需要把镜像传到镜像仓库比如Docker Hub。
  我们需要现在[Docker hub](https://hub.docker.com)注册，
  用注册的用户名替换掉前文提到的`username`。

* 注册成功之后，在本地服务器尝试登录，用以把登录信息存储在本地，方便后续使用。
  运行`docker login`，按提示输入用户名、密码和邮件。登录成功会返回
  `Login Succeeded`.

* 运行`docker push username/ubuntu-dev:v1`把准备好的镜像上传；
  等待片刻，完成上传。这时就可以再Docker hub上看到上传的镜像了。

* 其它用户可以使用 `docker pull username/ubuntu-dev:v1`来获取安装好编
  译环境的ubuntu系统了。
  

### 使用Dockerfile自动构建镜像

除了可以像上面那样一步步地获取镜像、修改容器、存储镜像、上传镜像等操作外，
我们还可以使用Dockerfile自动实现上述操作。

典型的Dockerfile如下所示，

```
FROM ubuntu
MAINTAINER username username@internet.com
RUN apt-get update
RUN apt-get install build-essential r-base
COPY ~/.bash_aliases ~/
```
* `FROM`为除注释之外的第一条命令，用来声明镜像的基础系统。
* `MAINTAINER`设置镜像维护人的信息。
* `RUN`在容器内部运行shell命令。
* `COPY`是把本地的bash配置文件拷贝到新维护的镜像中；这里只是展示COPY命令的使用。

运行命令`docker build -t="username/ubuntu-dev:v1" .`就可以构建镜像了。
最后的`.`表示Dockerfile在当前目录，也可指定其他目录。



### 参考
* <http://blog.saymagic.cn/2015/06/01/learning-docker.html>

